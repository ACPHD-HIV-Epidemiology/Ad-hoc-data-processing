%macro non_null_var;
%global all_but_null_var;
%let all_but_null_var=year
	Group	Alameda_County	Alameda	Albany	Ashland	Berkeley	Castro_Valley	Cherryland	Dublin	Emeryville	Fairview	Fremont	
	Hayward	Livermore	Newark	Oakland	Piedmont	Pleasanton	San_Leandro	San_Lorenzo	Sunol	Union_City	Rem_of_County	ctz06001400100	ctz06001400200	
	ctz06001400300	ctz06001400400	ctz06001400500	ctz06001400600	ctz06001400700	ctz06001400800	ctz06001400900	ctz06001401000	ctz06001401100	
	ctz06001401200	ctz06001401300	ctz06001401400	ctz06001401500	ctz06001401600	ctz06001401700	ctz06001401800	ctz06001401900_402200	
	ctz06001402000	ctz06001402100_402300	ctz06001402400	ctz06001402500	ctz06001402600	ctz06001402700	ctz06001402800	ctz06001402900	
	ctz06001403000	ctz06001403100	ctz06001403200	ctz06001403300	ctz06001403400	ctz06001403500	ctz06001403600	ctz06001403700	
	ctz06001403800	ctz06001403900	ctz06001404000	ctz06001404100	ctz06001404200	ctz06001404300	ctz06001404400	ctz06001404501	
	ctz06001404502	ctz06001404600	ctz06001404700	ctz06001404800	ctz06001404900	ctz06001405000	ctz06001405100	ctz06001405200	
	ctz06001405300	ctz06001405400	ctz06001405500	ctz06001405600	ctz06001405700	ctz06001405800	ctz06001405900	ctz06001406000	
	ctz06001406100	ctz06001406201	ctz06001406202	ctz06001406300	ctz06001406400	ctz06001406500	ctz06001406600	ctz06001406700	
	ctz06001406800	ctz06001406900	ctz06001407000	ctz06001407100	ctz06001407200	ctz06001407300	ctz06001407400	ctz06001407500	
	ctz06001407600	ctz06001407700	ctz06001407800	ctz06001407900	ctz06001408000	ctz06001408100	ctz06001408200	ctz06001408300	
	ctz06001408400	ctz06001408500	ctz06001408600	ctz06001408700	ctz06001408800	ctz06001408900	ctz06001409000	ctz06001409100	
	ctz06001409200	ctz06001409300	ctz06001409400	ctz06001409500	ctz06001409600	ctz06001409700	ctz06001409800	ctz06001409900	
	ctz06001410000	ctz06001410100	ctz06001410200	ctz06001410300	ctz06001410400	ctz06001420100	ctz06001420200	ctz06001420300	
	ctz06001420400	ctz06001420500	ctz06001420600	ctz06001421100	ctz06001421200	ctz06001421300	ctz06001421400	ctz06001421500	
	ctz06001421600	ctz06001421700	ctz06001421800	ctz06001421900	ctz06001422000	ctz06001422100	ctz06001422200	ctz06001422300	
	ctz06001422400	ctz06001422500	ctz06001422600	ctz06001422700	ctz06001422800	ctz06001422900	ctz06001423000	ctz06001423100	
	ctz06001423200	ctz06001423300	ctz06001423400	ctz06001423500	ctz06001423601	ctz06001423602	ctz06001423700	ctz06001423800	
	ctz06001423901	ctz06001423902	ctz06001424001	ctz06001424002	ctz06001425100	ctz06001426100	ctz06001426200	ctz06001427100	
	ctz06001427200	ctz06001427300	ctz06001427400_427500	ctz06001427600	ctz06001427700	ctz06001427800	ctz06001427900	ctz06001428000	
	ctz06001428100	ctz06001428200	ctz06001428301	ctz06001428302	ctz06001428400	ctz06001428500	ctz06001428600	ctz06001430100	ctz06001430200	
	ctz06001430300	ctz06001430400	ctz06001430500	ctz06001430600	ctz06001430700	ctz06001430800	ctz06001430900	ctz06001431000	ctz06001431100	
	ctz06001431200	ctz06001432100	ctz06001432200	ctz06001432300	ctz06001432400	ctz06001432500	ctz06001432600	ctz06001432700	ctz06001432800	
	ctz06001433000	ctz06001433101	ctz06001433102	ctz06001433200	ctz06001433300	ctz06001433400	ctz06001433500	ctz06001433600	ctz06001433700	
	ctz06001433800	ctz06001433900	ctz06001434000	ctz06001435101	ctz06001435102	ctz06001435200	ctz06001435300	ctz06001435400	ctz06001435500	
	ctz06001435600	ctz06001435700	ctz06001435800	ctz06001435900	ctz06001436000	ctz06001436100	ctz06001436200	ctz06001436300	ctz06001436401	
	ctz06001436402	ctz06001436500	ctz06001436601	ctz06001436602	ctz06001436700	ctz06001436800	ctz06001436900	ctz06001437000	ctz06001437100	
	ctz06001437200	ctz06001437300	ctz06001437400	ctz06001437500	ctz06001437600	ctz06001437700	ctz06001437800	ctz06001437900	ctz06001438000	
	ctz06001438100	ctz06001438201	ctz06001438202	ctz06001438300	ctz06001438400	ctz06001440100	ctz06001440200	ctz06001440301	ctz06001440302	
	ctz06001440304	ctz06001440305	ctz06001440306	ctz06001440307	ctz06001440308	ctz06001440309	ctz06001440331	ctz06001440332	ctz06001441100	
	ctz06001441200	ctz06001441301	ctz06001441302	ctz06001441401	ctz06001441402	ctz06001441501	ctz06001441503	ctz06001441521	ctz06001441522	
	ctz06001441601	ctz06001441602	ctz06001441700	ctz06001441800	ctz06001441901	ctz06001441921	ctz06001441922	ctz06001441923	ctz06001442000	
	ctz06001442100	ctz06001442200	ctz06001442300	ctz06001442400	ctz06001442500	ctz06001442600	ctz06001442700	ctz06001442800	ctz06001442900	
	ctz06001443001	ctz06001443002	ctz06001443101	ctz06001443102	ctz06001443103	ctz06001443200	ctz06001443301	ctz06001443302	ctz06001444100	
	ctz06001444200	ctz06001444300	ctz06001444400	ctz06001444500	ctz06001444600	ctz06001450100	ctz06001450200	ctz06001450300	ctz06001450400	
	ctz06001450500	ctz06001450601	ctz06001450602	ctz06001450603	ctz06001450604	ctz06001450605	ctz06001450606	ctz06001450607	ctz06001450701	
	ctz06001450703	ctz06001450721	ctz06001450722	ctz06001450741	ctz06001450742	ctz06001451101	ctz06001451102	ctz06001451201	ctz06001451202	
	ctz06001451300	ctz06001451401	ctz06001451402	ctz06001451501	ctz06001451502	ctz06001451503	ctz06001451601	ctz06001451602	ctz06001451701	
	ctz06001451702	ctz94501	ctz94502	ctz94536	ctz94538	ctz94539	ctz94541	ctz94542	ctz94544	ctz94545	ctz94546	
	ctz94550_total_2000	ctz94550_part_in_2000	ctz94550_total_2005	ctz94550_part_in_2005	ctz94551_total	ctz94551_part_in	ctz94550_94551_part_in	
	ctz94552	ctz94555	ctz94560	ctz94566	ctz94568	ctz94577	ctz94578	ctz94579	ctz94580	ctz94586	ctz94587	ctz94588_total	
	ctz94588_part_in	ctz94601	ctz94602	ctz94603	ctz94605	ctz94605_94613	ctz94606	ctz94607	ctz94608	ctz94609	ctz94610	
	ctz94611	ctz94612	ctz94613	ctz94618	ctz94619	ctz94621	ctz94702	ctz94703	ctz94704	ctz94704_94720	ctz94705	ctz94706_total	
	ctz94707_total	ctz94708_total	ctz94706_part_in	ctz94707_part_in	ctz94708_part_in	ctz94709	ctz94710	ctz94720	
	ctzRem_94505_94514_95377_95391;
%mend; %non_null_var; run;

/********************************************************************************************************************************************************/ data _null;
/*Import and manipulate year-specific denominator datasets as required for subsequent processing*/
/********************************************************************************************************************************************************/ run;
	libname denoms "S:\HIV-AIDS Analysis\Denoms\Denom CSVs by year";

	%macro import; /*Import year-specific datasets and add YEAR variable to each*/
		%do i=2000 %to 2012;
			proc Import out=denoms_&i.
						datafile="S:\HIV-AIDS Analysis\Denoms\Denom CSVs by year\&i..csv"
						dbms=CSV
						replace;
						guessingrows=32767;
			run;
		
			data denoms_&i.; set denoms_&i.;
				length year 4;
				year=&i.; 
				keep &all_but_null_var.;
			run;
		%end;
	%mend; %import; run;

	data denoms.denoms_wide(rename=(group=demog)); /*Concatenate all year-specific datasets into a single dataset*/
		set denoms_2000 denoms_2001 denoms_2002 denoms_2003 denoms_2004 denoms_2005 
			denoms_2006 denoms_2007 denoms_2008 denoms_2009 denoms_2010 denoms_2011 denoms_2012;
	run;

		proc sql; create table geo_var as /*Create dataset containing geographic variable names with which to use call execute (below)*/
			select name
			from dictionary.columns 
			where memname="DENOMS_WIDE" and name not in ("year" "demog");

			data _null_; set geo_var; /*For each of the geographic variables (all variables but DEMOG and YEAR)...*/
				call execute ("proc sql; create table "||name||" as
									select demog, year, '"||name||"' as geo, "||name||" as denom
									from denoms.denoms_wide;");

				/*	Create a dataset with (1) the DEMOG variable,   data _null_;
											(2) the YEAR variable, 
											(3) the name of the geographic variable (i.e., the place) with the name GEO, and 
											(4) the geographic variable renamed as DENOM 
					Give the dataset the name of the place to which it corresponds*/
			run;

		proc sql; select name into :sets separated by " " /*Concatenate all datasets created in call execute above*/
			from dictionary.columns 
			where memname="DENOMS_WIDE" and name not in ("year" "demog");
		data denoms.denoms_long; set &sets.; run; 

/********************************************************************************************************************************************************/ data _null;
/*Recode denoms_long*/
/********************************************************************************************************************************************************/ run;

	data denoms.denoms_master; 
		set denoms.denoms_long; /*Add variables for gender, race, and age and populate them according to the contents of the GROUP variable*/

		/*Create and populate the SEX variable*/
		length birth_sex $1;
		if index(demog,"Male") NE 0 then birth_sex="M";
		else if index(demog,"Female") NE 0 then birth_sex="F";
		else birth_sex="T";
		label birth_sex="Sex at birth";
		format birth_sex $birth_sex.;

		/*Create and populate the RACE variable*/
		length race_eth $2;
		if index(demog,"People who are Hispanic or Latino") NE 0 
			or index(demog,"Hisp_Lat") NE 0 then race_eth="E1";
		else if index(demog,"People who are White alone") NE 0 
			or index(demog,"White") NE 0 then race_eth="R5";
		else if index(demog,"People who are Black or African American alone") NE 0 
			or index(demog,"Black_AfAm") NE 0  then race_eth="R3";
		else if index(demog,"People who are American Indian and Alaska Native alone") NE 0  
			or index(demog,"AmerInd") NE 0 then race_eth="R1";
		else if index(demog,"People who are Asian alone") NE 0  
			or index(demog,"Asian") NE 0 then race_eth="R2";
		else if index(demog,"People who are Native Hawaiian and Other Pacific Islander alone") NE 0  
			or index(demog,"PacIsl") NE 0 then race_eth="R4";
		else if index(demog,"People who are Some other race alone") NE 0  
			or index(demog,"Some Other Race") NE 0 then race_eth="O";
		else if index(demog,"People who are Two or more races") NE 0  
			or index(demog,"Multirace") NE 0 then race_eth="M";
		else race_eth="T";
		label race_eth="Combined racial/ethnic categories";
		format race_eth race_eth2Fl.;

		/*Remove the string "; not Hispanic or Latino: " from the DEMOG variable so that it doesn't interfere with the indexing of the second semi-colon in the below code*/
		demog=tranwrd(demog,"; not Hispanic or Latino: ","");
		demog=tranwrd(demog,"_not Hispanic or Latino: ","");
		demog=tranwrd(demog,"Hisp_Lat","Hisp Lat");
		demog=tranwrd(demog,"Black_AfAm","Black AfAm");

		/*Create and populate the AGE variable*/
		length age 3;
		if index(demog,"Under 1 year") NE 0 then age=0;
		else if index(demog,"100 to 104 years") NE 0 then age=100;
		else if index(demog,"105 to 109 years") NE 0 then age=105;
		else if index(demog,"110 years and over") NE 0 then age=110;
		else if index(demog,";") NE 0 then do;
			if prxmatch("/[ ][2-9]{1} years/",demog) then do;
				age=input(substr(demog,index(demog,";")+2,1),3.);
			end;
			else do;
				age=input(substr(demog,index(demog,";")+2,2),3.);
			end;
		end;
		else if index(demog,"_") NE 0 then do;
			if prxmatch("/_[2-9]{1} years/",demog) then do;
				age=input(substr(demog,index(demog,"_")+1,1),3.);
			end;
			else do;
				age=input(substr(demog,index(demog,"_")+1,2),3.);
			end;
		end;
		else age=999;

		/*Define age grouping variables*/
		agegrp1=put(age,agegrp1Fs.); /*uses formats defined above to designate age group based on grouping scheme 1 and store a short code corr. to that group in a new variable*/
		agegrp2=put(age,agegrp2Fs.); /*same as bove but using grouping scheme 2*/
		label agegrp1="Age group" 
			  agegrp2="Age group";
		format agegrp1 agegrp1Fl.
			   agegrp2 agegrp2Fl.;

		/*Delete unwanted character strings from values in the GEO variable*/
		geo=tranwrd(geo,"ctz","");
		geo=tranwrd(geo,"_"," ");
		geo=tranwrd(geo,"Rem ","Remainder ");

		/*Replace inter-censal counts interpolated as negative*/
		if denom<0 then denom=0;
		else if denom NE floor(denom) then denom=floor(denom);
	run;

		*proc sql; /*check above code*/
/*			create table check_birth_sex as*/
/*				select distinct demog, birth_sex*/
/*				from denoms.denoms_master*/
/*				order by birth_sex;*/
/**/
/*			create table check_race_eth as*/
/*				select distinct demog, race_eth*/
/*				from denoms.denoms_master*/
/*				order by race_eth;*/
/**/
/*			create table check_agegrp1 as*/
/*				select distinct demog, agegrp1*/
/*				from denoms.denoms_master*/
/*				order by agegrp1;*/
/**/
/*			create table check_agegrp2 as*/
/*				select distinct demog, agegrp2*/
/*				from denoms.denoms_master*/
/*				order by agegrp2;*/
/*		quit;*/

/********************************************************************************************************************************************************/ data _null;
/*Create denom data subsets for specific purposes (i.e., tables vs mapping)*/
/********************************************************************************************************************************************************/ run;

	%macro geo_denom; /*Create denom dataset for mapping*/
		data denoms_geo; 
			set denoms.denoms_long;
			where demog="Total Total";

			%do year=2000 %to 2012;
				length denom_&year. 4;
				if year=&year. then denom_&year.=denom;
				else denom_&year.=0;
			%end;

			drop denom year demog;
		run;

		proc sql;
			create table denoms.denoms_geo as
				select 	tranwrd(geo,"ctz","") as geo 
						sum(denom_2000) as denom_2000, 
						sum(denom_2001) as denom_2001, 
						sum(denom_2002) as denom_2002, 
						sum(denom_2003) as denom_2003, 
						sum(denom_2004) as denom_2004, 
						sum(denom_2005) as denom_2005, 
						sum(denom_2006) as denom_2006,
						sum(denom_2007) as denom_2007, 
						sum(denom_2008) as denom_2008, 
						sum(denom_2009) as denom_2009, 
						sum(denom_2010) as denom_2010, 
						sum(denom_2011) as denom_2011, 
						sum(denom_2012) as denom_2012
				from denoms_geo
				group by geo
				order by geo;
	%mend; 
	%geo_denom; run;

	proc format; value $NewCityFs_denom
		"Alameda County"="00"
		"Berkeley"="01"
		"Albany"="02"
		"Alameda"="03"
		"Castro Valley"="04"
		"Dublin"="05"
		"Emeryville"="06"
		"Fremont"="07"
		"Hayward"="08"
		"Livermore"="09"
		"Newark"="10"
		"Oakland"="11"
		"Piedmont"="12"
		"Pleasanton"="13"
		"San Leandro"="14"
		"San Lorenzo"="15"
		"Sunol"="16"
		"Union City"="17"
		"Ashland"="18"
		"Cherryland"="19"
		"Fairview"="20"
		"Out of County"="21"
		"Rem of County"="22"
		"Remainder of County"="22";

	%macro demog_denom; /*Create denom datasets for breakdowns by demographic variables and by city*/
		%do i=1 %to 2;
			proc sql; create table denoms.denoms_agegrp&i.(rename=(race_eth1=race_eth agegrp&i.=agegrp)) as
				select 	year, 
						put(geo,$NewCityFs_denom.) as place format=$NewCityFl., 
						birth_sex, 
						put(race_eth,$race_eth2Fs.) as race_eth1 format=$race_eth2Fl., 
						agegrp&i., 
						sum(denom) as denom
				from denoms.denoms_master
				where geo in ('Alameda County' &AlCo_cities_lc. 'Rem of County' 'Remainder of County')
				group by year, place, birth_sex, race_eth1, agegrp&i.;
		%end;
	%mend; %demog_denom; run;

/********************************************************************************************************************************************************/ data _null_;
/*Add totals 
	(1) by agegrp ACROSS sex and race
and (2) by race_eth and agegrp ACROSS sex*/
/********************************************************************************************************************************************************/ run;

	%macro demog_denom;
		proc sql;
			%do i=1 %to 2;
				create table agegrp&i._totals as
					select 	year, 
							put(geo,$NewCityFs_denom.) as place format=$NewCityFl., 
							"T" as birth_sex length=1 format=$race_eth2Fl., 
							"T" as race_eth length=2 format=$race_eth2Fl., 
							agegrp&i. as agegrp, 
							sum(denom) as denom
					from denoms.denoms_master
					where race_eth='T' and birth_sex NE 'T' and geo in (&AlCo_cities_lc. 'Alameda County' 'Rem of County')
					group by year, geo, agegrp&i.;
			%end;
		quit;
	%mend; %demog_denom; run;

	%macro demog_denom;
		proc sql;
			%do i=1 %to 2;
				create table race_agegrp&i._subtotals(rename=(race_eth1=race_eth)) as
						select 	year, 
								put(geo,$NewCityFs_denom.) as place format=$NewCityFl., 
								"T" as birth_sex length=1 format=$birth_sex., 
								put(race_eth,$race_eth2Fs.) as race_eth1 format=$race_eth2Fl_denom., 
								agegrp&i. as agegrp, 
								sum(denom) as denom
						from denoms.denoms_master
						where birth_sex NE 'T' and race_eth NE 'T' and geo in (&AlCo_cities_lc. 'Alameda County' 'Rem of County')
						group by year, geo, race_eth1, agegrp&i.;
			%end;
		quit;
	%mend; %demog_denom; run;

/********************************************************************************************************************************************************/ data _null_;
/*Add records for region to denom datasets*/
/********************************************************************************************************************************************************/ run;

	%macro regions;
			%do i=1 %to 2;
				data denoms_reg&i.; 
					set denoms.denoms_agegrp&i.;
					where put(place, $NewCityFl.) not in ('ALAMEDA COUNTY' 'REMAINDER OF COUNTY');

					length region $2;
					if put(place, $NewCityFl.) in ('ALBANY', 'BERKELEY') then region='23';
					else if put(place, $NewCityFl.) in('ALAMEDA', 'EMERYVILLE',  'OAKLAND ', 'PIEDMONT') then region='24';
					else if put(place, $NewCityFl.) in ('SAN LEANDRO', 'SAN LORENZO', 'ASHLAND', 'CHERRYLAND', 'FAIRVIEW', 'CASTRO VALLEY', 'HAYWARD') then region='25';
					else if put(place, $NewCityFl.) in ('FREMONT', 'NEWARK', 'UNION CITY', 'SUNOL') then region='26';
					else if put(place, $NewCityFl.) in ('DUBLIN', 'LIVERMORE', 'PLEASANTON') then region='27';
					format region $NewCityFl.;
				run;

				proc sql;
					create table denoms_by_region&i.(rename=(place1=place)) as
						select 	year, 
								region as place1, 
								birth_sex,
								race_eth,
								agegrp,
								sum(denom) as denom
						from denoms_reg&i.
						group by year, region, birth_sex, race_eth, agegrp;
			%end;
		quit;
	%mend; %regions; run;

	data denoms.denoms1; 
		set denoms.denoms_agegrp1
			agegrp1_totals 		
			race_agegrp1_subtotals		
			denoms_by_region1; 
	run;

	data denoms.denoms2; 
		set denoms.denoms_agegrp2 
			agegrp2_totals 	
			race_agegrp2_subtotals
			denoms_by_region2; 
	run;

	/*	options replace;*/
	proc sort data=denoms.denoms1 nodupkey dupout=dups1; by year place birth_sex race_eth agegrp; run;
	proc sort data=denoms.denoms2 nodupkey dupout=dups2; by year place birth_sex race_eth agegrp; run;

ods _all_ close;
	ods TAGSETS.EXCELXP 
		file="&Output_path.\&today_date. Denoms.xls" 
		style=statistical
		options(
			/*contents='yes' */
			embedded_titles='yes' 
			embedded_footnotes='yes'
			EMBED_TITLES_ONCE='yes'
			EMBED_FOOTERS_ONCE='yes'
			sheet_interval="none"
/*			AUTOFILTER='NONE'*/
			AUTOFILTER='ALL' 
			);

	ods tagsets.ExcelXP options (sheet_interval="none" sheet_name="Denoms1");
		proc print data=denoms.denoms1; run;

	ods tagsets.ExcelXP options (sheet_interval="none" sheet_name="Denoms2");
		proc print data=denoms.denoms2; run;

ods _all_ close;
ods listing;